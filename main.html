<html>
  <head>
    <title>Simple Geometry Test</title>
  </head>

  <style>
  body {margin: 0;}
  canvas {width: 100%; height: 100%;}
  </style>

  <body>
	<link rel="shortcut icon" href="#">

   
    <style>
    			body {
    				font-family: Monospace;
    				background-color: #000;
    				color: #fff;
    				margin: 0px;
    				overflow: hidden;
    			}
    			#info {
    				position: absolute;
    				top: 10px;
    				width: 100%;
    				text-align: center;
    			}
    </style>

    <div id="info">
      <p>This is the first example using threeJS</p>
    </div>

		<script type="importmap">
			{
				"imports": {
					"three": "../build/three.module.js"
				}
			}
		</script>
    
	<script type="module">

	import * as THREE from 'three';
    import { OrbitControls } from './build/controls/OrbitControls.js'
    import {GUI} from './dat.gui-master/build/dat.gui.module.js';

    //create the scene
    var scene = new THREE.Scene( );
    var ratio = window.innerWidth/window.innerHeight;
    //create the perspective camera
    //for parameters see https://threejs.org/docs/#api/cameras/PerspectiveCamera
    var camera = new THREE.PerspectiveCamera(45,ratio,0.1,1000);

    //create the orthographics camera
    //for parameters see https://threejs.org/docs/#api/cameras/OrthographicCamera
    //var scale=15/(window.innerWidth+window.innerHeight);
    //var camera = new THREE.OrthographicCamera( -window.innerWidth*scale, window.innerWidth*scale, window.innerHeight*scale, -window.innerHeight*scale, 0.1, 1000 );

    //set the camera position
    camera.position.set(0,0,15);
    // and the direction
	  camera.lookAt(0,0,1);

    //create the webgl renderer
    var renderer = new THREE.WebGLRenderer( );

    //set the size of the rendering window
    renderer.setSize(window.innerWidth,window.innerHeight);
    
    
    setInterval(function(){
        timeToSpawnSphere();
    }, 1000);

    setTimeout(function(){
        setInterval(function(){
            removeSphere();
        }, 1000)
    }, 30000)
    

    render();

    renderer.render(scene,camera);

    //////////////
	// FUNCTIONS //
	//////////////


    var spheres = [];
    var maxSphere = 20;

    var sphereGeometry = new THREE.SphereGeometry(0.1, 8, 4);
    var startPosition = new THREE.Vector3(0, -5, 0);

    var tornado = {
        maxSphere: 20,
        width: 0,
        height: 0,
        isRandomColor: true,
    };

    const gui = new GUI();
    const sphereFolder = gui.addFolder('Sphere');
    sphereFolder.add(sphereGeometry.parameters, 'radius', 0.1, 3);
    sphereFolder.add(startPosition, 'y', -5, 10).name("Start y position");
    sphereFolder.open();

    var goOutPosition = new THREE.Vector3(1, 0, 0);
    
    const tornadoFolder = gui.addFolder('Tornado');
    tornadoFolder.add(tornado, 'maxSphere', 10, 100).name("Max Sphere");
    tornadoFolder.add(tornado, 'width', 0, 10).name("Width");
    tornadoFolder.add(tornado, 'height', 0, 40).name("Height");
    tornadoFolder.add(tornado, 'isRandomColor', 0, 1).name("Random Color");
    tornadoFolder.open();

    function timeToSpawnSphere()
    {
        if (spheres.length >= tornado.maxSphere) return;

        spawnSphere(sphereGeometry, startPosition);
    }

    function spawnSphere(geometry_sphere, position)
    {
        //add the renderer to the current document
        document.body.appendChild(renderer.domElement );

        //create the material of the cube (basic material)
        var material_sphere = new THREE.MeshBasicMaterial();
        //set the color of the cube
        if (tornado.isRandomColor)
        {
            var hex = "0x" + "000000".replace(/0/g,function(){return (~~(Math.random()*16)).toString(16);});
            material_sphere.color.setHex(hex);
        }
        else 
        {
            material_sphere.color = new THREE.Color( 'skyblue' );
        }
        //then set the renderer to wireframe
        // material_sphere.wireframe = true;
        //create the mesh of a cube
        var sphere = new THREE.Mesh(geometry_sphere, material_sphere);

        var radius = geometry_sphere.parameters.radius;
        var scale = radius / 0.1; 
        sphere.scale.setScalar(scale);

        sphere.position.x = position.x; 
        sphere.position.y = position.y; 
        sphere.position.z = position.z; 

        spheres.push(sphere);
        //and add to the scene
        scene.add(sphere);
    }

    function rotateAroundOrbit(time, sphere)
    {
        var rotY = new THREE.Matrix4();
        rotY.makeRotationY(Math.PI / 300);
        var tra = new THREE.Matrix4();
        tra.makeTranslation(0.05 + tornado.width / 100, 0, 0);

        sphere.applyMatrix4(tra);
        sphere.applyMatrix4(rotY);

        sphere.position.y += (0.005 + tornado.height / 1000);
    }

    function render(time) {
        time *= 0.001;
        if (spheres != null)
        {
            spheres.forEach(sphere => {
                rotate(time, sphere);
                rotateAroundOrbit(time, sphere);
            });
        }

        requestAnimationFrame(render);
    }

    function rotate(time, sphere)
    {
        sphere.rotation.x = time;
        sphere.rotation.y = time;
 
        renderer.render(scene, camera);
    }

    function removeSphere()
    {
        scene.remove(spheres.shift());
    }

    //////////////
	// CONTROLS //
	//////////////

	// move mouse and: left   click to rotate,
	//                 middle click to zoom,
	//                 right  click to pan
  // add the new control and link to the current camera to transform its position

    var controls = new OrbitControls(camera, renderer.domElement);

    var MyUpdateLoop = function () {
        renderer.render(scene, camera);
        controls.update();

        requestAnimationFrame(MyUpdateLoop);
    };

    requestAnimationFrame(MyUpdateLoop);

    var MyResize = function()
    {
        var width = window.innerWidth;
        var height = window.innerHeight;
        renderer.setSize(width, height);
        camera.aspect = width/height;
        camera.updateProjectionMatrix();
        renderer.render(scene, camera);
    };

    window.addEventListener('resize', MyResize);

    </script>
  </body>
</html>
